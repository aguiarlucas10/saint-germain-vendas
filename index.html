<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Saint Germain ‚Äî Vendas B2B</title>
  <link href="https://fonts.googleapis.com/css2?family=Questrial&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    :root {
      --bg:       #000000;
      --surface:  #111111;
      --surface2: #1a1a1a;
      --border:   #2a2a2a;
      --text:     #ffffff;
      --muted:    #666666;
      --danger:   #e05252;
      --success:  #4caf7d;
      --radius:   10px;
      --font:     'Questrial', sans-serif;
      --font-mono:'DM Mono', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      overflow-x: hidden;
    }

    #app { display: flex; flex-direction: column; min-height: 100vh; }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 16px;
      height: 58px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }

    .logo {
      font-family: var(--font);
      font-size: 1rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo img { height: 32px; width: auto; object-fit: contain; }

    nav {
      display: flex;
      gap: 2px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 3px;
    }
    nav button {
      background: none; border: none; color: var(--muted);
      font-family: var(--font); font-size: 0.78rem;
      padding: 6px 12px; border-radius: 7px; cursor: pointer;
      transition: all .15s; white-space: nowrap; letter-spacing: 0.04em;
    }
    nav button.active { background: #ffffff; color: #000000; }
    nav button:not(.active):hover { color: var(--text); }

    main { flex: 1; padding: 16px; max-width: 680px; margin: 0 auto; width: 100%; }

    .section { display: none; }
    .section.active { display: block; }

    /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
    .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 16px; margin-bottom: 12px;
    }

    /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
    label {
      display: block; font-size: 0.7rem; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--muted); margin-bottom: 5px;
    }
    input, select, textarea {
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      border-radius: 7px; color: var(--text); font-family: var(--font);
      font-size: 0.9rem; padding: 10px 12px; transition: border-color .15s; -webkit-appearance: none;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #fff; }
    select option { background: var(--surface2); }
    textarea { resize: vertical; min-height: 80px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-group { margin-bottom: 12px; }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      border: none; border-radius: 7px; cursor: pointer; font-family: var(--font);
      font-size: 0.88rem; letter-spacing: 0.03em; padding: 10px 18px;
      transition: all .15s; white-space: nowrap;
    }
    .btn-primary { background: #ffffff; color: #000000; }
    .btn-primary:hover { background: #e0e0e0; }
    .btn-outline { background: none; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { background: #c94545; }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; }
    .btn-full { width: 100%; }
    .btn-icon {
      background: none; border: none; color: var(--muted); cursor: pointer;
      padding: 4px; border-radius: 5px; transition: color .15s; font-size: 1.1rem; line-height: 1;
    }
    .btn-icon:hover { color: var(--text); }

    /* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
    .badge {
      display: inline-block; padding: 2px 8px; border-radius: 4px;
      font-size: 0.7rem; font-family: var(--font-mono); letter-spacing: 0.05em;
    }
    .badge-white { background: rgba(255,255,255,.12); color: #fff; }
    .badge-success { background: rgba(76,175,125,.15); color: var(--success); }
    .badge-discount { background: rgba(255,255,255,.06); color: #aaa; border: 1px solid var(--border); }

    /* ‚îÄ‚îÄ LIST ITEMS ‚îÄ‚îÄ */
    .list-item {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 14px 16px; margin-bottom: 8px;
      display: flex; align-items: center; gap: 12px; cursor: pointer; transition: border-color .15s;
    }
    .list-item:hover { border-color: #fff; }
    .list-item .info { flex: 1; min-width: 0; }
    .list-item .name { font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .list-item .sub { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }
    .list-item .actions { display: flex; gap: 4px; }

    /* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
    .sec-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .sec-title { font-size: 1.2rem; letter-spacing: 0.04em; }

    /* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
    .search-wrap { position: relative; margin-bottom: 14px; }
    .search-wrap input { padding-left: 36px; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 0.9rem; }

    /* ‚îÄ‚îÄ PRODUTO PICKER ‚îÄ‚îÄ */
    #pedido-produtos-list {
      max-height: 260px; overflow-y: auto;
      border: 1px solid var(--border); border-radius: 7px; background: var(--bg);
    }
    .prod-pick-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; border-bottom: 1px solid var(--border); gap: 8px;
    }
    .prod-pick-item:last-child { border-bottom: none; }
    .prod-pick-item .pname { font-size: 0.88rem; flex: 1; }
    .prod-pick-item .pprice { font-family: var(--font-mono); font-size: 0.78rem; color: var(--muted); margin-right: 8px; }
    .qty-ctrl { display: flex; align-items: center; gap: 6px; background: var(--surface2); border-radius: 6px; padding: 2px 4px; }
    .qty-ctrl button {
      background: none; border: none; color: var(--text); font-size: 1rem;
      width: 24px; height: 24px; cursor: pointer; border-radius: 4px;
      transition: background .1s; display: flex; align-items: center; justify-content: center;
    }
    .qty-ctrl button:hover { background: var(--border); }
    .qty-ctrl .qty-num { font-family: var(--font-mono); font-size: 0.85rem; width: 28px; text-align: center; }

    /* ‚îÄ‚îÄ DESCONTO ‚îÄ‚îÄ */
    .desconto-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 14px 16px; margin-bottom: 12px;
    }
    .desconto-tiers { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin: 10px 0; }
    .desconto-tier {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 7px; padding: 10px 6px; text-align: center;
      cursor: pointer; transition: all .15s;
    }
    .desconto-tier:hover:not(.disabled) { border-color: #fff; }
    .desconto-tier.active { background: #fff; border-color: #fff; }
    .desconto-tier.active .tier-pct { color: #000; }
    .desconto-tier.active .tier-label { color: #555; }
    .desconto-tier.disabled { opacity: 0.3; cursor: not-allowed; }
    .tier-pct { font-family: var(--font-mono); font-size: 1.1rem; color: #fff; display: block; }
    .tier-label { font-size: 0.6rem; color: var(--muted); display: block; margin-top: 3px; letter-spacing: 0.02em; }
    .desconto-info { display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; color: var(--muted); margin-top: 6px; }
    .desconto-valor-display { font-family: var(--font-mono); color: var(--success); }

    /* ‚îÄ‚îÄ RESUMO ‚îÄ‚îÄ */
    .resumo-item {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.85rem; padding: 6px 0; border-bottom: 1px solid var(--border);
    }
    .resumo-item:last-child { border-bottom: none; }
    .resumo-desconto { display: flex; justify-content: space-between; font-size: 0.82rem; padding: 6px 0; }
    .resumo-desconto .val { font-family: var(--font-mono); color: var(--success); }
    .resumo-total {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 12px; padding-top: 12px; border-top: 1px solid #fff;
    }
    .resumo-total .label { font-size: 0.9rem; letter-spacing: 0.04em; }
    .resumo-total .value { font-family: var(--font-mono); font-size: 1.3rem; }

    /* ‚îÄ‚îÄ ORDER CARD ‚îÄ‚îÄ */
    .order-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 14px 16px; margin-bottom: 10px;
      cursor: pointer; transition: border-color .15s;
    }
    .order-card:hover { border-color: #fff; }
    .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
    .order-id { font-family: var(--font-mono); font-size: 0.7rem; color: var(--muted); }
    .order-client { font-size: 0.95rem; }
    .order-items-preview { font-size: 0.78rem; color: var(--muted); margin: 2px 0 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .order-footer { display: flex; align-items: center; justify-content: space-between; }
    .order-total { font-family: var(--font-mono); font-size: 1rem; }

    /* ‚îÄ‚îÄ DRAWER ‚îÄ‚îÄ */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.85); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: flex-end; justify-content: center; }
    .overlay.open { display: flex; }
    .drawer {
      background: var(--surface); border: 1px solid var(--border); border-bottom: none;
      border-radius: 16px 16px 0 0; width: 100%; max-width: 680px;
      max-height: 92vh; overflow-y: auto; padding: 20px 16px 32px; animation: slideUp .2s ease;
    }
    @keyframes slideUp { from { transform: translateY(60px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .drawer-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px; }
    .drawer-title { font-size: 1.1rem; letter-spacing: 0.04em; margin-bottom: 16px; }

    /* ‚îÄ‚îÄ CSV IMPORT ‚îÄ‚îÄ */
    .import-zone {
      border: 2px dashed var(--border); border-radius: var(--radius);
      padding: 28px 16px; text-align: center; cursor: pointer;
      transition: border-color .15s; margin-bottom: 12px;
    }
    .import-zone:hover { border-color: #fff; }
    .import-zone .icon { font-size: 2rem; margin-bottom: 8px; }
    .import-zone p { font-size: 0.85rem; color: var(--muted); }
    .import-zone p strong { color: var(--text); }
    #csv-input { display: none; }
    .import-preview { background: var(--bg); border: 1px solid var(--border); border-radius: 7px; overflow: hidden; margin-bottom: 12px; }
    .import-preview-row { display: grid; grid-template-columns: 1fr auto; padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 0.82rem; gap: 8px; }
    .import-preview-row:last-child { border-bottom: none; }
    .import-preview-row .iname { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .import-preview-row .ipreco { font-family: var(--font-mono); color: var(--muted); }
    .import-header { background: var(--surface2); font-size: 0.7rem; letter-spacing: 0.08em; color: var(--muted); text-transform: uppercase; }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed; bottom: 20px; left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: #fff; color: #000; font-family: var(--font);
      font-size: 0.85rem; padding: 10px 20px; border-radius: 40px;
      z-index: 999; transition: transform .25s ease; white-space: nowrap;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }

    /* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
    .empty { text-align: center; padding: 48px 16px; color: var(--muted); }
    .empty .icon { font-size: 2.5rem; margin-bottom: 12px; }
    .empty p { font-size: 0.88rem; line-height: 1.5; }

    /* ‚îÄ‚îÄ SETUP MODAL ‚îÄ‚îÄ */
    #setup-modal {
      position: fixed; inset: 0; background: #000;
      z-index: 500; display: flex; align-items: center; justify-content: center; padding: 16px;
    }
    #setup-modal .modal-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 28px 24px; max-width: 480px; width: 100%;
    }
    #setup-modal h2 { font-family: var(--font); font-size: 1.2rem; letter-spacing: 0.1em; margin-bottom: 6px; }
    #setup-modal p { font-size: 0.83rem; color: var(--muted); margin-bottom: 16px; line-height: 1.6; }
    #setup-modal p strong { color: var(--text); }
    #setup-modal .form-group { margin-bottom: 10px; }

    /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
    .divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
    .flex-end { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
    .text-muted { color: var(--muted); font-size: 0.8rem; }
    .mono { font-family: var(--font-mono); }
    .mt-8 { margin-top: 8px; }
    .mb-8 { margin-bottom: 8px; }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
    #login-modal {
      position: fixed; inset: 0; background: #000;
      z-index: 600; display: flex; align-items: center; justify-content: center; padding: 16px;
    }
    #login-modal .modal-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 32px 24px; max-width: 360px; width: 100%;
    }
    #login-modal h2 { font-size: 1.1rem; letter-spacing: 0.1em; margin-bottom: 4px; }
    #login-modal .subtitle { font-size: 0.8rem; color: var(--muted); margin-bottom: 24px; }
    #login-modal .form-group { margin-bottom: 12px; }
    #login-error { color: var(--danger); font-size: 0.78rem; margin-top: 8px; min-height: 18px; text-align: center; }

    /* User badge in header */
    .user-badge {
      display: flex; align-items: center; gap: 8px;
      font-size: 0.75rem; color: var(--muted); cursor: pointer;
    }
    .user-badge:hover { color: var(--text); }
    .user-avatar {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--surface2); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; color: var(--text);
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê LOGIN MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div id="login-modal">
  <div class="modal-box">
    <h2>SAINT GERMAIN</h2>
    <p class="subtitle">Fa√ßa login para continuar</p>
    <div class="form-group">
      <label>Usu√°rio</label>
      <input id="login-user" placeholder="seu usu√°rio" autocomplete="username" />
    </div>
    <div class="form-group">
      <label>Senha</label>
      <input id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
        onkeydown="if(event.key==='Enter') fazerLogin()" />
    </div>
    <div id="login-error"></div>
    <div class="flex-end" style="margin-top:16px;">
      <button class="btn btn-primary btn-full" onclick="fazerLogin()">Entrar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê SETUP MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div id="setup-modal">
  <div class="modal-box">
    <h2>SAINT GERMAIN</h2>
    <p>Configure o Firebase para sincronizar dados entre dispositivos em tempo real.</p>
    <div class="form-group"><label>API Key</label><input id="cfg-apiKey" /></div>
    <div class="form-group"><label>Auth Domain</label><input id="cfg-authDomain" /></div>
    <div class="form-group"><label>Project ID</label><input id="cfg-projectId" /></div>
    <div class="form-group"><label>App ID</label><input id="cfg-appId" /></div>
    <div class="flex-end">
      <button class="btn btn-outline btn-sm" onclick="usarLocalStorage()">Usar offline</button>
      <button class="btn btn-primary" onclick="iniciarFirebase()">Conectar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê -->
<div id="app" style="display:none;">
  <header>
    <div class="logo">
      <img id="logo-img" src="" alt="" style="display:none;" />
      <span id="logo-text">SAINT GERMAIN</span>
    </div>
    <nav>
      <button class="active" onclick="setTab('pedido', this)">Pedido</button>
      <button onclick="setTab('historico', this)">Hist√≥rico</button>
      <button class="admin-only" onclick="setTab('produtos', this)">Produtos</button>
      <button onclick="setTab('clientes', this)">Clientes</button>
      <button class="admin-only" onclick="setTab('vendedores', this)">Vendedores</button>
    </nav>
    <div class="user-badge" onclick="fazerLogout()" title="Sair">
      <div class="user-avatar" id="user-avatar">?</div>
      <span id="user-label"></span>
    </div>
  </header>

  <main>

    <!-- ‚ïê‚ïê PEDIDO ‚ïê‚ïê -->
    <section id="tab-pedido" class="section active">
      <div class="sec-header">
        <div class="sec-title">Novo Pedido</div>
        <button class="btn btn-outline btn-sm" onclick="limparPedido()">Limpar</button>
      </div>

      <div class="card">
        <label style="margin-bottom:10px;">Produtos</label>
        <div class="search-wrap mb-8">
          <span class="search-icon">üîç</span>
          <input id="search-prod" type="text" placeholder="Buscar produto..." oninput="renderProdutosPicker()" />
        </div>
        <div id="pedido-produtos-list"></div>
      </div>

      <!-- Desconto -->
      <div class="desconto-card" id="desconto-card" style="display:none;">
        <label style="margin-bottom:8px;">Desconto por volume</label>
        <div class="desconto-tiers">
          <div class="desconto-tier disabled" id="tier-3" onclick="aplicarDesconto(3)">
            <span class="tier-pct">3%</span>
            <span class="tier-label">at√© R$1.500</span>
          </div>
          <div class="desconto-tier disabled" id="tier-5" onclick="aplicarDesconto(5)">
            <span class="tier-pct">5%</span>
            <span class="tier-label">at√© R$3.000</span>
          </div>
          <div class="desconto-tier disabled" id="tier-7" onclick="aplicarDesconto(7)">
            <span class="tier-pct">7%</span>
            <span class="tier-label">at√© R$4.000</span>
          </div>
          <div class="desconto-tier disabled" id="tier-10" onclick="aplicarDesconto(10)">
            <span class="tier-pct">10%</span>
            <span class="tier-label">acima R$4.000</span>
          </div>
        </div>
        <div class="desconto-info">
          <span id="desconto-status">Nenhum desconto aplicado</span>
          <span class="desconto-valor-display" id="desconto-valor-display"></span>
        </div>
      </div>

      <!-- Resumo -->
      <div class="card" id="resumo-card" style="display:none;">
        <label style="margin-bottom:10px;">Resumo</label>
        <div id="resumo-itens"></div>
        <div id="resumo-desconto-row" class="resumo-desconto" style="display:none;">
          <span id="resumo-desconto-label">Desconto</span>
          <span class="val mono" id="resumo-desconto-val"></span>
        </div>
        <div class="resumo-total">
          <span class="label">Total</span>
          <span class="value" id="resumo-total-val">R$ 0,00</span>
        </div>
        <hr class="divider" />
        <div class="form-row">
          <div class="form-group">
            <label>Cliente *</label>
            <select id="pedido-cliente"><option value="">‚Äî Selecionar ‚Äî</option></select>
          </div>
          <div class="form-group">
            <label>Vendedor *</label>
            <select id="pedido-vendedor"><option value="">‚Äî Selecionar ‚Äî</option></select>
          </div>
        </div>
        <button class="btn btn-outline btn-sm mb-8" onclick="abrirDrawer('drawer-cliente')" style="margin-top:-4px;">+ Novo cliente</button>
        <div class="form-group mt-8">
          <label>Condi√ß√£o de Pagamento</label>
          <select id="pedido-pagamento">
            <option>√Ä vista</option><option>30 dias</option>
            <option>30/60</option><option>30/60/90</option>
            <option>Boleto</option><option>Cart√£o</option><option>PIX</option>
          </select>
        </div>
        <div class="form-group">
          <label>Observa√ß√µes</label>
          <textarea id="pedido-obs" placeholder="Ex: entrega ter√ßa, embalagem especial..."></textarea>
        </div>
        <div class="flex-end">
          <button class="btn btn-outline" onclick="imprimirPedido()">üñ® Imprimir</button>
          <button class="btn btn-primary" onclick="finalizarPedido()">‚úì Finalizar</button>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê HIST√ìRICO ‚ïê‚ïê -->
    <section id="tab-historico" class="section">
      <div class="sec-header">
        <div class="sec-title">Hist√≥rico</div>
        <button class="btn btn-outline btn-sm" onclick="exportarPedidos()">‚¨á Exportar CSV</button>
      </div>
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" id="search-hist" placeholder="Buscar por cliente ou produto..." oninput="renderHistorico()" />
      </div>
      <div id="lista-historico"></div>
    </section>

    <!-- ‚ïê‚ïê PRODUTOS ‚ïê‚ïê -->
    <section id="tab-produtos" class="section">
      <div class="sec-header">
        <div class="sec-title">Produtos</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-outline btn-sm" onclick="abrirDrawer('drawer-importar')">üì• Importar CSV</button>
          <button class="btn btn-primary btn-sm" onclick="abrirNovoProduto()">+ Produto</button>
        </div>
      </div>
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" id="search-produtos" placeholder="Buscar produto..." oninput="renderListaProdutos()" />
      </div>
      <div id="lista-produtos"></div>
    </section>

    <!-- ‚ïê‚ïê VENDEDORES ‚ïê‚ïê -->
    <section id="tab-vendedores" class="section">
      <div class="sec-header">
        <div class="sec-title">Vendedores</div>
        <button class="btn btn-primary btn-sm" onclick="abrirDrawer('drawer-vendedor')">+ Vendedor</button>
      </div>
      <div id="lista-vendedores"></div>
    </section>

    <!-- ‚ïê‚ïê CLIENTES ‚ïê‚ïê -->
    <section id="tab-clientes" class="section">
      <div class="sec-header">
        <div class="sec-title">Clientes</div>
        <button class="btn btn-primary btn-sm" onclick="abrirDrawer('drawer-cliente')">+ Cliente</button>
      </div>
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" id="search-clientes" placeholder="Buscar cliente..." oninput="renderListaClientes()" />
      </div>
      <div id="lista-clientes"></div>
    </section>

  </main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê DRAWERS ‚ïê‚ïê‚ïê‚ïê -->

<!-- Drawer Produto -->
<div class="overlay" id="drawer-produto">
  <div class="drawer">
    <div class="drawer-handle"></div>
    <div class="drawer-title" id="drawer-produto-title">Novo Produto</div>
    <input type="hidden" id="prod-id" />
    <div class="form-group"><label>Nome *</label><input id="prod-nome" placeholder="Ex: Vinho Tinto Reserva 750ml" /></div>
    <div class="form-row">
      <div class="form-group"><label>C√≥digo / SKU</label><input id="prod-sku" placeholder="VTR-750" /></div>
      <div class="form-group"><label>Categoria</label><input id="prod-categoria" placeholder="Vinhos" /></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Pre√ßo (R$) *</label><input id="prod-preco" type="number" step="0.01" placeholder="0,00" /></div>
      <div class="form-group"><label>Unidade</label>
        <select id="prod-unidade"><option>UN</option><option>CX</option><option>KG</option><option>LT</option><option>DZ</option></select>
      </div>
    </div>
    <div class="flex-end">
      <button class="btn btn-outline" onclick="fecharDrawer('drawer-produto')">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarProduto()">Salvar</button>
    </div>
  </div>
</div>

<!-- Drawer Importar CSV -->
<div class="overlay" id="drawer-importar">
  <div class="drawer">
    <div class="drawer-handle"></div>
    <div class="drawer-title">Importar Produtos via CSV</div>

    <div class="import-zone" id="import-zone" onclick="document.getElementById('csv-input').click()">
      <div class="icon">üìÑ</div>
      <p><strong>Clique para selecionar o arquivo CSV</strong></p>
      <p>ou arraste e solte aqui</p>
    </div>
    <input type="file" id="csv-input" accept=".csv,.txt" onchange="lerCSV(event)" />

    <div class="card" style="margin-bottom:12px; font-size:0.8rem; color:var(--muted); line-height:1.8;">
      <strong style="color:var(--text);">Formato do CSV:</strong><br/>
      Colunas reconhecidas (cabe√ßalho na 1¬™ linha):<br/>
      <span class="mono" style="color:#fff;">nome</span> (obrigat√≥rio) &nbsp;¬∑&nbsp;
      <span class="mono" style="color:#fff;">preco</span> (obrigat√≥rio) &nbsp;¬∑&nbsp;
      <span class="mono" style="color:#fff;">sku</span> &nbsp;¬∑&nbsp;
      <span class="mono" style="color:#fff;">categoria</span> &nbsp;¬∑&nbsp;
      <span class="mono" style="color:#fff;">unidade</span><br/>
      Separador: v√≠rgula <span class="mono">( , )</span> ou ponto-e-v√≠rgula <span class="mono">( ; )</span>
    </div>

    <div id="csv-preview" style="display:none;">
      <label style="margin-bottom:8px;">Pr√©via ‚Äî <span id="csv-count"></span></label>
      <div class="import-preview">
        <div class="import-preview-row import-header"><span>Nome</span><span>Pre√ßo</span></div>
        <div id="csv-preview-rows"></div>
      </div>
      <div class="flex-end">
        <button class="btn btn-outline" onclick="fecharDrawer('drawer-importar')">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarImportacao()">Importar todos</button>
      </div>
    </div>
  </div>
</div>

<!-- Drawer Vendedor -->
<div class="overlay" id="drawer-vendedor">
  <div class="drawer">
    <div class="drawer-handle"></div>
    <div class="drawer-title" id="drawer-vendedor-title">Novo Vendedor</div>
    <input type="hidden" id="vend-id" />
    <div class="form-group"><label>Nome *</label><input id="vend-nome" placeholder="Ex: Jo√£o Silva" /></div>
    <div class="form-group"><label>Telefone</label><input id="vend-tel" type="tel" placeholder="(48) 99999-9999" /></div>
    <div class="flex-end">
      <button class="btn btn-outline" onclick="fecharDrawer('drawer-vendedor')">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarVendedor()">Salvar</button>
    </div>
  </div>
</div>

<!-- Drawer Cliente -->
<div class="overlay" id="drawer-cliente">
  <div class="drawer">
    <div class="drawer-handle"></div>
    <div class="drawer-title" id="drawer-cliente-title">Novo Cliente</div>
    <input type="hidden" id="cli-id" />
    <div class="form-group"><label>Nome / Raz√£o Social *</label><input id="cli-nome" placeholder="Distribuidora ABC Ltda" /></div>
    <div class="form-row">
      <div class="form-group"><label>CNPJ / CPF</label><input id="cli-doc" placeholder="00.000.000/0001-00" /></div>
      <div class="form-group"><label>Telefone</label><input id="cli-tel" placeholder="(48) 99999-9999" type="tel" /></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Insc. Estadual <span style="color:var(--muted);font-size:.65rem;text-transform:none;">(opcional)</span></label><input id="cli-ie" placeholder="Isento ou n¬∫" /></div>
      <div class="form-group"><label>E-mail</label><input id="cli-email" type="email" placeholder="contato@empresa.com" /></div>
    </div>
    <div class="form-group"><label>Endere√ßo</label><input id="cli-end" placeholder="Rua, n¬∫, cidade - UF" /></div>
    <div class="form-group"><label>Observa√ß√µes</label><textarea id="cli-obs" placeholder="Notas sobre o cliente..."></textarea></div>
    <div class="flex-end">
      <button class="btn btn-outline" onclick="fecharDrawer('drawer-cliente')">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarCliente()">Salvar</button>
    </div>
  </div>
</div>

<!-- Drawer Pedido Detalhes -->
<div class="overlay" id="drawer-pedido-det">
  <div class="drawer">
    <div class="drawer-handle"></div>
    <div id="pedido-det-content"></div>
    <div class="flex-end">
      <button class="btn btn-danger btn-sm" onclick="excluirPedidoAtual()">Excluir</button>
      <button class="btn btn-outline" onclick="imprimirPedidoExistente()">üñ® Imprimir</button>
      <button class="btn btn-outline" onclick="fecharDrawer('drawer-pedido-det')">Fechar</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  USU√ÅRIOS / LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const USUARIOS = [
  { usuario: 'admin',   senha: 'sg2024admin', role: 'admin',    nome: 'Administrador' },
  { usuario: 'vendas',  senha: 'sg2024venda', role: 'vendedor', nome: 'Vendedor'      },
];

let usuarioAtual = null;

function fazerLogin() {
  const u = document.getElementById('login-user').value.trim().toLowerCase();
  const s = document.getElementById('login-pass').value;
  const found = USUARIOS.find(x => x.usuario === u && x.senha === s);
  if (!found) {
    document.getElementById('login-error').textContent = 'Usu√°rio ou senha incorretos.';
    document.getElementById('login-pass').value = '';
    return;
  }
  usuarioAtual = found;
  localStorage.setItem('sg_session', JSON.stringify({ usuario: found.usuario, role: found.role, nome: found.nome }));
  document.getElementById('login-modal').style.display = 'none';
  document.getElementById('login-error').textContent = '';
  aplicarPermissoes();
  iniciarApp();
}

function fazerLogout() {
  if (!confirm('Deseja sair?')) return;
  usuarioAtual = null;
  localStorage.removeItem('sg_session');
  location.reload();
}

function aplicarPermissoes() {
  // Update header badge
  document.getElementById('user-avatar').textContent = usuarioAtual.nome.charAt(0).toUpperCase();
  document.getElementById('user-label').textContent = usuarioAtual.nome;

  // Show/hide admin-only elements
  const isAdmin = usuarioAtual.role === 'admin';
  document.querySelectorAll('.admin-only').forEach(el => {
    el.style.display = isAdmin ? '' : 'none';
  });
}

function iniciarApp() {
  // Show firebase setup or go straight in
  const saved = localStorage.getItem('fb_config');
  if (saved) {
    try {
      const cfg = JSON.parse(saved);
      document.getElementById('cfg-apiKey').value = cfg.apiKey||'';
      document.getElementById('cfg-authDomain').value = cfg.authDomain||'';
      document.getElementById('cfg-projectId').value = cfg.projectId||'';
      document.getElementById('cfg-appId').value = cfg.appId||'';
      conectarFirebase(cfg);
    } catch(e) {
      document.getElementById('setup-modal').style.display = 'flex';
    }
  } else {
    // Pre-fill known config
    document.getElementById('cfg-apiKey').value = 'AIzaSyDyQWt_D950AoJFRCQBFyspG34ti0bWXro';
    document.getElementById('cfg-authDomain').value = 'banco-b2b-sg.firebaseapp.com';
    document.getElementById('cfg-projectId').value = 'banco-b2b-sg';
    document.getElementById('cfg-appId').value = '1:979394861028:web:650b17010d3ed44db219f1';
    document.getElementById('setup-modal').style.display = 'flex';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE / STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let db = null, useFirebase = false;
const LOCAL = {
  get: k => JSON.parse(localStorage.getItem(k) || '[]'),
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
};

function usarLocalStorage() {
  useFirebase = false;
  localStorage.removeItem('fb_config');
  document.getElementById('setup-modal').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  init(); toast('Modo offline ativo');
}

function iniciarFirebase() {
  const cfg = {
    apiKey:    document.getElementById('cfg-apiKey').value.trim(),
    authDomain:document.getElementById('cfg-authDomain').value.trim(),
    projectId: document.getElementById('cfg-projectId').value.trim(),
    appId:     document.getElementById('cfg-appId').value.trim(),
  };
  if (!cfg.apiKey || !cfg.projectId) { toast('Preencha API Key e Project ID'); return; }
  localStorage.setItem('fb_config', JSON.stringify(cfg));
  conectarFirebase(cfg);
}

function conectarFirebase(cfg) {
  try {
    if (!firebase.apps.length) firebase.initializeApp(cfg);
    db = firebase.firestore();
    useFirebase = true;
    document.getElementById('setup-modal').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    init(); toast('Firebase conectado!');
  } catch(e) { toast('Erro: ' + e.message); }
}

async function dbGetAll(col) {
  if (useFirebase) {
    const snap = await db.collection(col).get();
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  return LOCAL.get(col);
}

async function dbAdd(col, data) {
  if (useFirebase) {
    const ref = await db.collection(col).add({ ...data, _ts: Date.now() });
    return ref.id;
  }
  const arr = LOCAL.get(col);
  const id = 'l_' + Date.now() + '_' + Math.random().toString(36).substr(2,4);
  arr.unshift({ id, ...data, _ts: Date.now() });
  LOCAL.set(col, arr);
  return id;
}

async function dbAddBatch(col, items) {
  if (useFirebase) {
    // Firebase permite max 500 por batch
    const chunks = [];
    for (let i = 0; i < items.length; i += 400) chunks.push(items.slice(i, i+400));
    for (const chunk of chunks) {
      const batch = db.batch();
      chunk.forEach(data => batch.set(db.collection(col).doc(), { ...data, _ts: Date.now() }));
      await batch.commit();
    }
  } else {
    const arr = LOCAL.get(col);
    items.forEach(data => {
      arr.unshift({ id: 'l_' + Date.now() + '_' + Math.random().toString(36).substr(2,4), ...data, _ts: Date.now() });
    });
    LOCAL.set(col, arr);
  }
}

async function dbUpdate(col, id, data) {
  if (useFirebase) {
    await db.collection(col).doc(id).update(data);
  } else {
    const arr = LOCAL.get(col);
    const i = arr.findIndex(x => x.id === id);
    if (i >= 0) { arr[i] = { ...arr[i], ...data }; LOCAL.set(col, arr); }
  }
}

async function dbDelete(col, id) {
  if (useFirebase) { await db.collection(col).doc(id).delete(); }
  else { LOCAL.set(col, LOCAL.get(col).filter(x => x.id !== id)); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let produtos = [], clientes = [], pedidos = [];
let cart = {};
let descontoAtual = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  await carregarDados();
  renderProdutosPicker();
  renderListaProdutos();
  renderListaClientes();
  renderHistorico();
  popularSelectClientes();
  popularSelectVendedores();
}

async function carregarDados() {
  [produtos, clientes, pedidos, vendedores] = await Promise.all([
    dbGetAll('produtos'), dbGetAll('clientes'), dbGetAll('pedidos'), dbGetAll('vendedores'),
  ]);
  pedidos.sort((a,b) => (b._ts||0) - (a._ts||0));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTab(name, btn) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  btn.classList.add('active');
  if (name === 'historico')  renderHistorico();
  if (name === 'produtos')   renderListaProdutos();
  if (name === 'clientes')   renderListaClientes();
  if (name === 'vendedores') renderListaVendedores();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DESCONTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Tiers: qualquer valor d√° direito ao tier correspondente (vendedor decide)
// Habilitado: tier sempre dispon√≠vel se h√° itens no carrinho
// O vendedor escolhe qual aplicar ‚Äî pode aplicar 3% num pedido de R$5.000 se quiser

function aplicarDesconto(pct) {
  const tier = document.getElementById('tier-' + pct);
  if (tier.classList.contains('disabled')) return;
  if (descontoAtual === pct) {
    descontoAtual = 0;
    document.querySelectorAll('.desconto-tier').forEach(t => t.classList.remove('active'));
  } else {
    descontoAtual = pct;
    document.querySelectorAll('.desconto-tier').forEach(t => t.classList.remove('active'));
    tier.classList.add('active');
  }
  renderResumo();
}

function atualizarDescontoCard(bruto) {
  const card = document.getElementById('desconto-card');
  const temItens = Object.keys(cart).length > 0;
  card.style.display = temItens ? 'block' : 'none';

  // Habilitar tiers com base no valor bruto
  // Regra: tier 3% dispon√≠vel sempre; demais conforme faixas
  const rules = [
    { pct: 3,  minimo: 0    },
    { pct: 5,  minimo: 1500 },
    { pct: 7,  minimo: 3000 },
    { pct: 10, minimo: 4000 },
  ];
  rules.forEach(r => {
    const el = document.getElementById('tier-' + r.pct);
    if (!el) return;
    if (bruto >= r.minimo) {
      el.classList.remove('disabled');
    } else {
      el.classList.add('disabled');
      if (descontoAtual === r.pct) {
        descontoAtual = 0;
        el.classList.remove('active');
      }
    }
  });

  const valorDesc = bruto * (descontoAtual / 100);
  document.getElementById('desconto-status').textContent =
    descontoAtual ? `Desconto de ${descontoAtual}% aplicado` : 'Selecione um desconto';
  document.getElementById('desconto-valor-display').textContent =
    descontoAtual ? `- ${fmtPreco(valorDesc)}` : '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRODUTOS PICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProdutosPicker() {
  const q = (document.getElementById('search-prod')?.value||'').toLowerCase();
  const filtered = produtos.filter(p =>
    p.nome.toLowerCase().includes(q) ||
    (p.sku||'').toLowerCase().includes(q) ||
    (p.categoria||'').toLowerCase().includes(q)
  );
  const el = document.getElementById('pedido-produtos-list');
  if (!produtos.length) {
    el.innerHTML = '<div class="empty" style="padding:20px;"><p>Nenhum produto cadastrado ainda.</p></div>';
    return;
  }
  if (!filtered.length) {
    el.innerHTML = '<div class="empty" style="padding:20px;"><p>Nenhum resultado encontrado.</p></div>';
    return;
  }
  el.innerHTML = filtered.map(p => {
    const qty = cart[p.id] || 0;
    return `<div class="prod-pick-item">
      <span class="pname">${p.nome}${p.unidade ? ' <small style="color:var(--muted)">/ '+p.unidade+'</small>' : ''}</span>
      <span class="pprice">${fmtPreco(p.preco)}</span>
      <div class="qty-ctrl">
        <button onclick="addCart('${p.id}',-1)">‚àí</button>
        <span class="qty-num">${qty}</span>
        <button onclick="addCart('${p.id}',1)">+</button>
      </div>
    </div>`;
  }).join('');
}

function addCart(id, delta) {
  cart[id] = Math.max(0, (cart[id]||0) + delta);
  if (cart[id] === 0) delete cart[id];
  if (!Object.keys(cart).length) {
    descontoAtual = 0;
    document.querySelectorAll('.desconto-tier').forEach(t => t.classList.remove('active'));
  }
  renderProdutosPicker();
  renderResumo();
}

function renderResumo() {
  const itens = Object.entries(cart);
  const card = document.getElementById('resumo-card');
  if (!itens.length) { card.style.display = 'none'; atualizarDescontoCard(0); return; }
  card.style.display = 'block';

  const bruto = itens.reduce((s,[id,qty]) => {
    const p = produtos.find(x => x.id === id);
    return s + (p ? p.preco * qty : 0);
  }, 0);

  atualizarDescontoCard(bruto);

  const valorDesc = bruto * (descontoAtual / 100);
  const total = bruto - valorDesc;

  document.getElementById('resumo-itens').innerHTML = itens.map(([id,qty]) => {
    const p = produtos.find(x => x.id === id);
    if (!p) return '';
    return `<div class="resumo-item"><span>${p.nome} √ó ${qty}</span><span class="mono">${fmtPreco(p.preco*qty)}</span></div>`;
  }).join('');

  const descRow = document.getElementById('resumo-desconto-row');
  if (descontoAtual) {
    descRow.style.display = 'flex';
    document.getElementById('resumo-desconto-label').textContent = `Desconto ${descontoAtual}%`;
    document.getElementById('resumo-desconto-val').textContent = `- ${fmtPreco(valorDesc)}`;
  } else {
    descRow.style.display = 'none';
  }
  document.getElementById('resumo-total-val').textContent = fmtPreco(total);
}

function limparPedido() {
  cart = {}; descontoAtual = 0;
  document.getElementById('pedido-cliente').value = '';
  document.getElementById('pedido-obs').value = '';
  document.getElementById('pedido-vendedor').value = '';
  document.querySelectorAll('.desconto-tier').forEach(t => { t.classList.remove('active'); });
  renderProdutosPicker(); renderResumo();
}

async function finalizarPedido() {
  if (!Object.keys(cart).length) { toast('Adicione ao menos um produto'); return; }
  const clienteId = document.getElementById('pedido-cliente').value;
  if (!clienteId) { toast('Selecione um cliente'); return; }
  const vendedorId = document.getElementById('pedido-vendedor').value;
  if (!vendedorId) { toast('Selecione um vendedor'); return; }
  const cliente = clientes.find(c => c.id === clienteId);
  const itensPedido = Object.entries(cart).map(([id,qty]) => {
    const p = produtos.find(x => x.id === id);
    return { prodId: id, nome: p.nome, preco: p.preco, qty, subtotal: p.preco * qty };
  });
  const bruto = itensPedido.reduce((s,i) => s + i.subtotal, 0);
  const valorDesc = bruto * (descontoAtual / 100);
  const total = bruto - valorDesc;
  const vendedor = vendedores.find(v => v.id === vendedorId);
  await dbAdd('pedidos', {
    clienteId, clienteNome: cliente.nome,
    vendedorId: vendedorId||'', vendedorNome: vendedor?.nome||'',
    itens: itensPedido, bruto, desconto: descontoAtual, valorDesconto: valorDesc, total,
    obs: document.getElementById('pedido-obs').value,
    pagamento: document.getElementById('pedido-pagamento').value,
    data: new Date().toISOString(), status: 'finalizado',
  });
  pedidos = await dbGetAll('pedidos');
  pedidos.sort((a,b) => (b._ts||0) - (a._ts||0));
  toast('Pedido finalizado!');
  limparPedido();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LISTA PRODUTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderListaProdutos() {
  const q = (document.getElementById('search-produtos')?.value||'').toLowerCase();
  const filtered = produtos.filter(p => p.nome.toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q));
  const el = document.getElementById('lista-produtos');
  if (!filtered.length) {
    el.innerHTML = `<div class="empty"><div class="icon">üì¶</div><p>Nenhum produto cadastrado.<br/>Clique em "+ Produto" ou importe um CSV.</p></div>`;
    return;
  }
  el.innerHTML = filtered.map(p => `
    <div class="list-item">
      <div class="info">
        <div class="name">${p.nome}</div>
        <div class="sub">${p.sku ? p.sku + ' ¬∑ ' : ''}${p.categoria||'Sem categoria'} ¬∑ ${p.unidade||'UN'}</div>
      </div>
      <span class="badge badge-white mono">${fmtPreco(p.preco)}</span>
      ${usuarioAtual?.role === 'admin' ? `<div class="actions">
        <button class="btn-icon" onclick="editarProduto('${p.id}');event.stopPropagation()">‚úèÔ∏è</button>
        <button class="btn-icon" onclick="excluirProduto('${p.id}');event.stopPropagation()">üóë</button>
      </div>` : ''}
    </div>`).join('');
}

function abrirNovoProduto() {
  document.getElementById('drawer-produto-title').textContent = 'Novo Produto';
  document.getElementById('prod-id').value = '';
  ['prod-nome','prod-sku','prod-categoria','prod-preco'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('prod-unidade').value = 'UN';
  abrirDrawer('drawer-produto');
}

function editarProduto(id) {
  const p = produtos.find(x => x.id === id);
  if (!p) return;
  document.getElementById('drawer-produto-title').textContent = 'Editar Produto';
  document.getElementById('prod-id').value = p.id;
  document.getElementById('prod-nome').value = p.nome||'';
  document.getElementById('prod-sku').value = p.sku||'';
  document.getElementById('prod-categoria').value = p.categoria||'';
  document.getElementById('prod-preco').value = p.preco||'';
  document.getElementById('prod-unidade').value = p.unidade||'UN';
  abrirDrawer('drawer-produto');
}

async function salvarProduto() {
  if (usuarioAtual?.role !== 'admin') { toast('Sem permiss√£o'); return; }
  const nome = document.getElementById('prod-nome').value.trim();
  const preco = parseFloat(document.getElementById('prod-preco').value);
  if (!nome) { toast('Informe o nome do produto'); return; }
  if (isNaN(preco) || preco < 0) { toast('Informe um pre√ßo v√°lido'); return; }
  const data = { nome, preco, sku: document.getElementById('prod-sku').value.trim(), categoria: document.getElementById('prod-categoria').value.trim(), unidade: document.getElementById('prod-unidade').value };
  const id = document.getElementById('prod-id').value;
  if (id) { await dbUpdate('produtos', id, data); toast('Produto atualizado'); }
  else { await dbAdd('produtos', data); toast('Produto salvo'); }
  produtos = await dbGetAll('produtos');
  fecharDrawer('drawer-produto');
  renderListaProdutos(); renderProdutosPicker();
}

async function excluirProduto(id) {
  if (usuarioAtual?.role !== 'admin') { toast('Sem permiss√£o'); return; }
  if (!confirm('Excluir este produto?')) return;
  await dbDelete('produtos', id);
  produtos = produtos.filter(x => x.id !== id);
  renderListaProdutos(); renderProdutosPicker();
  toast('Produto removido');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CSV IMPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let csvParaImportar = [];

function lerCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => processarCSV(e.target.result);
  reader.readAsText(file, 'UTF-8');
  event.target.value = '';
}

function normCol(str) {
  return str.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
}

function processarCSV(texto) {
  const sep = (texto.split(';').length > texto.split(',').length) ? ';' : ',';
  const linhas = texto.split(/\r?\n/).filter(l => l.trim());
  if (linhas.length < 2) { toast('CSV vazio ou inv√°lido'); return; }

  const header = linhas[0].split(sep).map(normCol);
  const idxNome  = header.findIndex(h => ['nome','produto','descricao','item','name'].includes(h));
  const idxPreco = header.findIndex(h => ['preco','valor','pvenda','price','preco'].includes(h));
  const idxSku   = header.findIndex(h => ['sku','codigo','cod','ref','referencia','code'].includes(h));
  const idxCat   = header.findIndex(h => ['categoria','grupo','tipo','category'].includes(h));
  const idxUn    = header.findIndex(h => ['unidade','un','und','unit'].includes(h));

  if (idxNome === -1)  { toast('Coluna "nome" n√£o encontrada'); return; }
  if (idxPreco === -1) { toast('Coluna "preco" n√£o encontrada'); return; }

  csvParaImportar = [];
  let ignorados = 0;

  for (let i = 1; i < linhas.length; i++) {
    const cols = linhas[i].split(sep).map(c => c.trim().replace(/^"|"$/g,''));
    const nome = cols[idxNome];
    if (!nome) continue;
    const ps = (cols[idxPreco]||'0').replace(/[^\d,\.]/g,'').replace(',','.');
    const preco = parseFloat(ps);
    if (isNaN(preco)) { ignorados++; continue; }
    csvParaImportar.push({
      nome, preco,
      sku:       idxSku >= 0 ? (cols[idxSku]||'') : '',
      categoria: idxCat >= 0 ? (cols[idxCat]||'') : '',
      unidade:   idxUn  >= 0 ? (cols[idxUn] ||'UN') : 'UN',
    });
  }

  if (!csvParaImportar.length) { toast('Nenhum produto v√°lido encontrado'); return; }

  document.getElementById('csv-count').textContent = `${csvParaImportar.length} produtos encontrados`;
  const preview = csvParaImportar.slice(0, 8);
  document.getElementById('csv-preview-rows').innerHTML =
    preview.map(p => `<div class="import-preview-row"><span class="iname">${p.nome}</span><span class="ipreco">${fmtPreco(p.preco)}</span></div>`).join('') +
    (csvParaImportar.length > 8 ? `<div class="import-preview-row" style="color:var(--muted)"><span>... e mais ${csvParaImportar.length-8} produtos</span><span></span></div>` : '');

  document.getElementById('csv-preview').style.display = 'block';
  if (ignorados) toast(`${ignorados} linha(s) ignorada(s) por erro`);
}

async function confirmarImportacao() {
  if (!csvParaImportar.length) return;
  const btn = event.target;
  btn.textContent = 'Importando...';
  btn.disabled = true;
  await dbAddBatch('produtos', csvParaImportar);
  produtos = await dbGetAll('produtos');
  fecharDrawer('drawer-importar');
  renderListaProdutos(); renderProdutosPicker();
  document.getElementById('csv-preview').style.display = 'none';
  toast(`${csvParaImportar.length} produtos importados!`);
  csvParaImportar = [];
  btn.textContent = 'Importar todos';
  btn.disabled = false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VENDEDORES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let vendedores = [];

function popularSelectVendedores() {
  const sel = document.getElementById('pedido-vendedor');
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî Selecionar vendedor ‚Äî</option>' +
    vendedores.map(v => `<option value="${v.id}">${v.nome}</option>`).join('');
  if (cur) sel.value = cur;
}

function renderListaVendedores() {
  const el = document.getElementById('lista-vendedores');
  if (!vendedores.length) {
    el.innerHTML = `<div class="empty"><div class="icon">üßë‚Äçüíº</div><p>Nenhum vendedor cadastrado.</p></div>`;
    return;
  }
  el.innerHTML = vendedores.map(v => `
    <div class="list-item">
      <div class="info">
        <div class="name">${v.nome}</div>
        <div class="sub">${v.tel||''}</div>
      </div>
      <div class="actions">
        <button class="btn-icon" onclick="editarVendedor('${v.id}');event.stopPropagation()">‚úèÔ∏è</button>
        <button class="btn-icon" onclick="excluirVendedor('${v.id}');event.stopPropagation()">üóë</button>
      </div>
    </div>`).join('');
}

function editarVendedor(id) {
  const v = vendedores.find(x => x.id === id);
  if (!v) return;
  document.getElementById('drawer-vendedor-title').textContent = 'Editar Vendedor';
  document.getElementById('vend-id').value = v.id;
  document.getElementById('vend-nome').value = v.nome||'';
  document.getElementById('vend-tel').value = v.tel||'';
  abrirDrawer('drawer-vendedor');
}

async function salvarVendedor() {
  if (usuarioAtual?.role !== 'admin') { toast('Sem permiss√£o'); return; }
  const nome = document.getElementById('vend-nome').value.trim();
  if (!nome) { toast('Informe o nome do vendedor'); return; }
  const data = { nome, tel: document.getElementById('vend-tel').value.trim() };
  const id = document.getElementById('vend-id').value;
  if (id) { await dbUpdate('vendedores', id, data); toast('Vendedor atualizado'); }
  else    { await dbAdd('vendedores', data); toast('Vendedor salvo'); }
  vendedores = await dbGetAll('vendedores');
  fecharDrawer('drawer-vendedor');
  renderListaVendedores();
  popularSelectVendedores();
}

async function excluirVendedor(id) {
  if (usuarioAtual?.role !== 'admin') { toast('Sem permiss√£o'); return; }
  if (!confirm('Excluir este vendedor?')) return;
  await dbDelete('vendedores', id);
  vendedores = vendedores.filter(x => x.id !== id);
  renderListaVendedores();
  popularSelectVendedores();
  toast('Vendedor removido');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLIENTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function popularSelectClientes() {
  const sel = document.getElementById('pedido-cliente');
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî Selecionar cliente ‚Äî</option>' +
    clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
  if (cur) sel.value = cur;
}

function renderListaClientes() {
  const q = (document.getElementById('search-clientes')?.value||'').toLowerCase();
  const filtered = clientes.filter(c => c.nome.toLowerCase().includes(q) || (c.doc||'').includes(q));
  const el = document.getElementById('lista-clientes');
  if (!filtered.length) {
    el.innerHTML = `<div class="empty"><div class="icon">üë•</div><p>Nenhum cliente cadastrado.</p></div>`;
    return;
  }
  el.innerHTML = filtered.map(c => `
    <div class="list-item">
      <div class="info">
        <div class="name">${c.nome}</div>
        <div class="sub">${c.doc||''}${c.ie ? ' ¬∑ IE: '+c.ie : ''}${(c.doc||c.ie)&&c.tel?' ¬∑ ':''}${c.tel||''}</div>
      </div>
      <div class="actions">
        <button class="btn-icon" onclick="editarCliente('${c.id}');event.stopPropagation()">‚úèÔ∏è</button>
        <button class="btn-icon" onclick="excluirCliente('${c.id}');event.stopPropagation()">üóë</button>
      </div>
    </div>`).join('');
}

function editarCliente(id) {
  const c = clientes.find(x => x.id === id);
  if (!c) return;
  document.getElementById('drawer-cliente-title').textContent = 'Editar Cliente';
  document.getElementById('cli-id').value = c.id;
  document.getElementById('cli-nome').value = c.nome||'';
  document.getElementById('cli-doc').value = c.doc||'';
  document.getElementById('cli-ie').value = c.ie||'';
  document.getElementById('cli-tel').value = c.tel||'';
  document.getElementById('cli-email').value = c.email||'';
  document.getElementById('cli-end').value = c.end||'';
  document.getElementById('cli-obs').value = c.obs||'';
  abrirDrawer('drawer-cliente');
}

async function salvarCliente() {
  const nome = document.getElementById('cli-nome').value.trim();
  if (!nome) { toast('Informe o nome do cliente'); return; }
  const data = { nome, doc: document.getElementById('cli-doc').value.trim(), ie: document.getElementById('cli-ie').value.trim(), tel: document.getElementById('cli-tel').value.trim(), email: document.getElementById('cli-email').value.trim(), end: document.getElementById('cli-end').value.trim(), obs: document.getElementById('cli-obs').value.trim() };
  const id = document.getElementById('cli-id').value;
  if (id) { await dbUpdate('clientes', id, data); toast('Cliente atualizado'); }
  else { await dbAdd('clientes', data); toast('Cliente salvo'); }
  clientes = await dbGetAll('clientes');
  fecharDrawer('drawer-cliente');
  renderListaClientes(); popularSelectClientes();
}

async function excluirCliente(id) {
  if (!confirm('Excluir este cliente?')) return;
  await dbDelete('clientes', id);
  clientes = clientes.filter(x => x.id !== id);
  renderListaClientes(); popularSelectClientes();
  toast('Cliente removido');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HIST√ìRICO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistorico() {
  const q = (document.getElementById('search-hist')?.value||'').toLowerCase();
  const filtered = pedidos.filter(p =>
    (p.clienteNome||'').toLowerCase().includes(q) ||
    (p.itens||[]).some(i => i.nome.toLowerCase().includes(q))
  );
  const el = document.getElementById('lista-historico');
  if (!filtered.length) {
    el.innerHTML = `<div class="empty"><div class="icon">üìã</div><p>Nenhum pedido registrado ainda.</p></div>`;
    return;
  }
  el.innerHTML = filtered.map(p => {
    const preview = (p.itens||[]).map(i => `${i.nome} √ó${i.qty}`).join(', ');
    const dt = p.data ? new Date(p.data).toLocaleDateString('pt-BR', {day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
    return `<div class="order-card" onclick="abrirPedidoDet('${p.id}')">
      <div class="order-header">
        <div><div class="order-client">${p.clienteNome||'‚Äî'}</div><div class="order-id">${dt}${p.vendedorNome ? ' ¬∑ ' + p.vendedorNome : ''}</div></div>
        <div style="display:flex;gap:6px;align-items:center;">
          ${p.desconto ? `<span class="badge badge-discount">-${p.desconto}%</span>` : ''}
          <span class="badge badge-white">${p.pagamento||'‚Äî'}</span>
        </div>
      </div>
      <div class="order-items-preview">${preview}</div>
      <div class="order-footer">
        <span class="text-muted">${(p.itens||[]).length} item(s)</span>
        <span class="order-total mono">${fmtPreco(p.total||0)}</span>
      </div>
    </div>`;
  }).join('');
}

let pedidoDetAtual = null;
function abrirPedidoDet(id) {
  const p = pedidos.find(x => x.id === id);
  if (!p) return;
  pedidoDetAtual = p;
  const dt = p.data ? new Date(p.data).toLocaleDateString('pt-BR', {day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
  const rows = (p.itens||[]).map(i => `<div class="resumo-item"><span>${i.nome} √ó ${i.qty}</span><span class="mono">${fmtPreco(i.subtotal)}</span></div>`).join('');
  document.getElementById('pedido-det-content').innerHTML = `
    <div class="drawer-title">Pedido ‚Äî ${p.clienteNome}</div>
    <p class="text-muted mb-8">${dt}</p>
    <div class="card" style="margin-bottom:12px;">
      <label style="margin-bottom:8px;">Itens</label>
      ${rows}
      ${p.desconto ? `<div class="resumo-desconto" style="margin-top:6px;"><span>Desconto ${p.desconto}%</span><span class="val mono">- ${fmtPreco(p.valorDesconto||0)}</span></div>` : ''}
      <div class="resumo-total"><span class="label">Total</span><span class="value mono">${fmtPreco(p.total||0)}</span></div>
    </div>
    <div class="card">
      <div class="form-row">
        <div><label>Pagamento</label><p>${p.pagamento||'‚Äî'}</p></div>
        <div><label>Vendedor</label><p>${p.vendedorNome||'‚Äî'}</p></div>
      </div>
      <div style="margin-top:8px;"><label>Status</label><span class="badge badge-success">${p.status||'finalizado'}</span></div>
      ${p.obs ? `<hr class="divider"/><label>Obs.</label><p style="font-size:.85rem;margin-top:4px;">${p.obs}</p>` : ''}
    </div>`;
  abrirDrawer('drawer-pedido-det');
}

async function excluirPedidoAtual() {
  if (usuarioAtual?.role !== 'admin') { toast('Sem permiss√£o para excluir pedidos'); return; }
  if (!pedidoDetAtual || !confirm('Excluir este pedido?')) return;
  await dbDelete('pedidos', pedidoDetAtual.id);
  pedidos = pedidos.filter(x => x.id !== pedidoDetAtual.id);
  fecharDrawer('drawer-pedido-det');
  renderHistorico(); toast('Pedido exclu√≠do');
}

function imprimirPedidoExistente() { if (pedidoDetAtual) gerarImpressao(pedidoDetAtual); }

function imprimirPedido() {
  const clienteId = document.getElementById('pedido-cliente').value;
  const cliente = clientes.find(c => c.id === clienteId);
  const itens = Object.entries(cart).map(([id,qty]) => {
    const p = produtos.find(x => x.id === id);
    return { nome: p.nome, qty, preco: p.preco, subtotal: p.preco * qty };
  });
  const bruto = itens.reduce((s,i)=>s+i.subtotal,0);
  const valorDesc = bruto * (descontoAtual/100);
  gerarImpressao({ clienteNome: cliente?.nome||'‚Äî', itens, bruto, desconto: descontoAtual, valorDesconto: valorDesc, total: bruto-valorDesc, obs: document.getElementById('pedido-obs').value, pagamento: document.getElementById('pedido-pagamento').value, data: new Date().toISOString() });
}

function gerarImpressao(p) {
  const dt = new Date(p.data).toLocaleDateString('pt-BR',{day:'2-digit',month:'long',year:'numeric'});
  const rows = (p.itens||[]).map(i => `<tr><td>${i.nome}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right">${fmtPreco(i.preco)}</td><td style="text-align:right"><strong>${fmtPreco(i.subtotal)}</strong></td></tr>`).join('');
  const descRow = p.desconto ? `<tr><td colspan="3" style="text-align:right;padding-top:6px;color:#555;">Desconto ${p.desconto}%</td><td style="text-align:right;padding-top:6px;color:#555;">- ${fmtPreco(p.valorDesconto||0)}</td></tr>` : '';
  const w = window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"/>
  <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet"/>
  <style>body{font-family:'Questrial',sans-serif;padding:32px;color:#000;max-width:680px;margin:0 auto;}h1{font-size:1.4rem;letter-spacing:.1em;margin-bottom:4px;}.sub{color:#666;font-size:.8rem;margin-bottom:24px;}table{width:100%;border-collapse:collapse;margin-bottom:8px;}th{border-bottom:2px solid #000;text-align:left;padding:6px 0;font-size:.75rem;letter-spacing:.08em;text-transform:uppercase;}td{border-bottom:1px solid #ddd;padding:7px 0;font-size:.85rem;}.total{text-align:right;font-size:1.1rem;border-top:2px solid #000;padding-top:8px;margin-top:4px;}.footer{margin-top:40px;font-size:.72rem;color:#aaa;border-top:1px solid #eee;padding-top:12px;}</style></head><body>
  <h1>SAINT GERMAIN</h1>
  <div class="sub">Pedido de Venda ¬∑ ${dt}</div>
  <p><strong>Cliente:</strong> ${p.clienteNome}</p>
  ${p.vendedorNome ? `<p><strong>Vendedor:</strong> ${p.vendedorNome}</p>` : ''}
  <p><strong>Pagamento:</strong> ${p.pagamento||'‚Äî'}</p>
  ${p.obs?`<p><strong>Obs.:</strong> ${p.obs}</p>`:''}
  <br/>
  <table><thead><tr><th>Produto</th><th style="text-align:center">Qtd</th><th style="text-align:right">Pre√ßo Un.</th><th style="text-align:right">Subtotal</th></tr></thead><tbody>${rows}${descRow}</tbody></table>
  <div class="total">TOTAL: ${fmtPreco(p.total||0)}</div>
  <div class="footer">Saint Germain ¬∑ Sistema de Vendas B2B</div>
  </body></html>`);
  w.document.close(); w.print();
}

function exportarPedidos() {
  const linhas = [['Data','Cliente','Vendedor','Produtos','Subtotal Bruto','Desconto %','Valor Desconto','Total','Pagamento','Obs']];
  pedidos.forEach(p => {
    linhas.push([
      p.data ? new Date(p.data).toLocaleDateString('pt-BR') : '',
      p.clienteNome||'',
      p.vendedorNome||'',
      (p.itens||[]).map(i=>`${i.nome} x${i.qty}`).join('; '),
      (p.bruto||p.total||0).toFixed(2),
      (p.desconto||0)+'%',
      (p.valorDesconto||0).toFixed(2),
      (p.total||0).toFixed(2),
      p.pagamento||'', p.obs||''
    ]);
  });
  const csv = linhas.map(r => r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURIComponent(csv);
  a.download = 'pedidos_saint_germain.csv';
  a.click(); toast('CSV exportado!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAWERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function abrirDrawer(id) {
  if (id === 'drawer-vendedor') {
    document.getElementById('drawer-vendedor-title').textContent = 'Novo Vendedor';
    document.getElementById('vend-id').value = '';
    ['vend-nome','vend-tel'].forEach(f => document.getElementById(f).value='');
  }
  if (id === 'drawer-cliente') {
    document.getElementById('drawer-cliente-title').textContent = 'Novo Cliente';
    document.getElementById('cli-id').value = '';
    ['cli-nome','cli-doc','cli-ie','cli-tel','cli-email','cli-end','cli-obs'].forEach(f => document.getElementById(f).value='');
  }
  document.getElementById(id).classList.add('open');
}
function fecharDrawer(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(ov => {
  ov.addEventListener('click', e => { if (e.target === ov) fecharDrawer(ov.id); });
});

// Drag & drop CSV
const iz = document.getElementById('import-zone');
if (iz) {
  iz.addEventListener('dragover', e => { e.preventDefault(); iz.style.borderColor='#fff'; });
  iz.addEventListener('dragleave', () => { iz.style.borderColor=''; });
  iz.addEventListener('drop', e => {
    e.preventDefault(); iz.style.borderColor='';
    const f = e.dataTransfer.files[0];
    if (f) { const r = new FileReader(); r.onload = ev => processarCSV(ev.target.result); r.readAsText(f,'UTF-8'); }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}

function fmtPreco(v) {
  return 'R$ ' + Number(v||0).toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ BOOT: check session ‚îÄ‚îÄ
const savedSession = localStorage.getItem('sg_session');
if (savedSession) {
  try {
    usuarioAtual = JSON.parse(savedSession);
    document.getElementById('login-modal').style.display = 'none';
    aplicarPermissoes();
    iniciarApp();
  } catch(e) {
    document.getElementById('login-modal').style.display = 'flex';
  }
} else {
  document.getElementById('login-modal').style.display = 'flex';
}
</script>
</body>
</html>
