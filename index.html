<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Saint Germain â€” Vendas B2B</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />

  <!-- Firebase v8 compat (reliable CDN) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    :root {
      --bg:       #0f0f0f;
      --surface:  #1a1a1a;
      --surface2: #222222;
      --border:   #2e2e2e;
      --amber:    #f5a623;
      --amber-dim:#b87a1a;
      --text:     #e8e2d9;
      --muted:    #7a7570;
      --danger:   #e05252;
      --success:  #4caf7d;
      --radius:   10px;
      --font-head: 'Syne', sans-serif;
      --font-mono: 'DM Mono', monospace;
      --font-body: 'DM Sans', sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { font-size: 16px; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€ LAYOUT â”€â”€ */
    #app { display: flex; flex-direction: column; min-height: 100vh; }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 16px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }

    .logo {
      font-family: var(--font-head);
      font-weight: 800;
      font-size: 1.1rem;
      letter-spacing: 0.04em;
      color: var(--amber);
    }
    .logo span { color: var(--muted); font-weight: 400; }

    nav {
      display: flex;
      gap: 2px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 3px;
    }
    nav button {
      background: none;
      border: none;
      color: var(--muted);
      font-family: var(--font-body);
      font-size: 0.78rem;
      font-weight: 500;
      padding: 6px 12px;
      border-radius: 7px;
      cursor: pointer;
      transition: all .15s;
      white-space: nowrap;
    }
    nav button.active {
      background: var(--amber);
      color: #0f0f0f;
      font-weight: 700;
    }
    nav button:not(.active):hover { color: var(--text); }

    main { flex: 1; padding: 16px; max-width: 680px; margin: 0 auto; width: 100%; }

    /* â”€â”€ SECTIONS â”€â”€ */
    .section { display: none; }
    .section.active { display: block; }

    /* â”€â”€ CARDS â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }

    /* â”€â”€ FORM ELEMENTS â”€â”€ */
    label {
      display: block;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 5px;
    }

    input, select, textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-family: var(--font-body);
      font-size: 0.9rem;
      padding: 10px 12px;
      transition: border-color .15s;
      -webkit-appearance: none;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--amber);
    }
    select option { background: var(--surface2); }

    textarea { resize: vertical; min-height: 80px; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-group { margin-bottom: 12px; }

    /* â”€â”€ BUTTONS â”€â”€ */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-family: var(--font-body);
      font-weight: 600;
      font-size: 0.88rem;
      padding: 10px 18px;
      transition: all .15s;
      white-space: nowrap;
    }
    .btn-primary { background: var(--amber); color: #0f0f0f; }
    .btn-primary:hover { background: #ffc44d; }
    .btn-outline {
      background: none;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn-outline:hover { border-color: var(--amber); color: var(--amber); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { background: #c94545; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; }
    .btn-full { width: 100%; }
    .btn-icon {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 5px;
      transition: color .15s;
      font-size: 1.1rem;
      line-height: 1;
    }
    .btn-icon:hover { color: var(--text); }

    /* â”€â”€ BADGE â”€â”€ */
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      font-family: var(--font-mono);
      letter-spacing: 0.05em;
    }
    .badge-amber { background: rgba(245,166,35,.15); color: var(--amber); }
    .badge-success { background: rgba(76,175,125,.15); color: var(--success); }
    .badge-muted { background: var(--surface2); color: var(--muted); }

    /* â”€â”€ LIST ITEMS â”€â”€ */
    .list-item {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: border-color .15s;
    }
    .list-item:hover { border-color: var(--amber); }
    .list-item .info { flex: 1; min-width: 0; }
    .list-item .name {
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .list-item .sub {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 2px;
    }
    .list-item .actions { display: flex; gap: 4px; }

    /* â”€â”€ SECTION HEADER â”€â”€ */
    .sec-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .sec-title {
      font-family: var(--font-head);
      font-weight: 700;
      font-size: 1.2rem;
    }

    /* â”€â”€ SEARCH â”€â”€ */
    .search-wrap {
      position: relative;
      margin-bottom: 14px;
    }
    .search-wrap input { padding-left: 36px; }
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 0.9rem;
    }

    /* â”€â”€ PEDIDO BUILDER â”€â”€ */
    #pedido-produtos-list {
      max-height: 240px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 7px;
      background: var(--bg);
    }
    .prod-pick-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      gap: 8px;
    }
    .prod-pick-item:last-child { border-bottom: none; }
    .prod-pick-item .pname { font-size: 0.88rem; flex: 1; }
    .prod-pick-item .pprice {
      font-family: var(--font-mono);
      font-size: 0.78rem;
      color: var(--amber);
      margin-right: 8px;
    }
    .qty-ctrl {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--surface2);
      border-radius: 6px;
      padding: 2px 4px;
    }
    .qty-ctrl button {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1rem;
      width: 24px;
      height: 24px;
      cursor: pointer;
      border-radius: 4px;
      transition: background .1s;
      display: flex; align-items: center; justify-content: center;
    }
    .qty-ctrl button:hover { background: var(--border); }
    .qty-ctrl .qty-num {
      font-family: var(--font-mono);
      font-size: 0.85rem;
      width: 28px;
      text-align: center;
    }

    /* â”€â”€ RESUMO PEDIDO â”€â”€ */
    .resumo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }
    .resumo-item:last-child { border-bottom: none; }
    .resumo-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 2px solid var(--amber);
    }
    .resumo-total .label {
      font-family: var(--font-head);
      font-weight: 700;
      font-size: 0.9rem;
    }
    .resumo-total .value {
      font-family: var(--font-mono);
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--amber);
    }

    /* â”€â”€ ORDER HISTORY â”€â”€ */
    .order-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      margin-bottom: 10px;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .order-id {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      color: var(--muted);
    }
    .order-client {
      font-weight: 700;
      font-size: 0.95rem;
    }
    .order-items-preview {
      font-size: 0.78rem;
      color: var(--muted);
      margin: 4px 0 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .order-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .order-total {
      font-family: var(--font-mono);
      font-size: 1rem;
      font-weight: 700;
      color: var(--amber);
    }

    /* â”€â”€ MODAL / DRAWER â”€â”€ */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.7);
      backdrop-filter: blur(3px);
      z-index: 200;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }
    .overlay.open { display: flex; }
    .drawer {
      background: var(--surface);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 680px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px 16px 32px;
      animation: slideUp .2s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(60px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }
    .drawer-handle {
      width: 36px; height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 0 auto 20px;
    }
    .drawer-title {
      font-family: var(--font-head);
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 16px;
    }

    /* â”€â”€ TOAST â”€â”€ */
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 0.85rem;
      font-weight: 500;
      padding: 10px 20px;
      border-radius: 40px;
      z-index: 999;
      transition: transform .25s ease;
      white-space: nowrap;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }

    /* â”€â”€ EMPTY STATE â”€â”€ */
    .empty {
      text-align: center;
      padding: 48px 16px;
      color: var(--muted);
    }
    .empty .icon { font-size: 2.5rem; margin-bottom: 12px; }
    .empty p { font-size: 0.88rem; line-height: 1.5; }

    /* â”€â”€ FIRESTORE CONFIG â”€â”€ */
    .config-banner {
      background: rgba(245,166,35,.08);
      border: 1px solid var(--amber-dim);
      border-radius: var(--radius);
      padding: 14px 16px;
      margin-bottom: 16px;
      font-size: 0.82rem;
      line-height: 1.6;
      color: var(--text);
    }
    .config-banner strong { color: var(--amber); }

    /* â”€â”€ PRINT â”€â”€ */
    @media print {
      body { background: #fff; color: #000; }
      header, nav, .no-print { display: none !important; }
      .print-area { display: block !important; }
      * { border-color: #ccc !important; }
    }

    /* â”€â”€ MISC â”€â”€ */
    .divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
    .flex-end { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
    .text-muted { color: var(--muted); font-size: 0.8rem; }
    .mono { font-family: var(--font-mono); }
    .mt-8 { margin-top: 8px; }
    .mb-8 { margin-bottom: 8px; }

    /* scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Firebase setup modal */
    #setup-modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.95);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    #setup-modal .modal-box {
      background: var(--surface);
      border: 1px solid var(--amber-dim);
      border-radius: 14px;
      padding: 28px 24px;
      max-width: 480px;
      width: 100%;
    }
    #setup-modal h2 {
      font-family: var(--font-head);
      font-weight: 800;
      font-size: 1.3rem;
      color: var(--amber);
      margin-bottom: 8px;
    }
    #setup-modal p {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 20px;
      line-height: 1.6;
    }
    #setup-modal code {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      display: block;
      font-family: var(--font-mono);
      font-size: 0.72rem;
      color: var(--amber);
      margin: 8px 0 16px;
      overflow-x: auto;
    }
    #setup-modal .form-group { margin-bottom: 10px; }
    #setup-modal label { font-size: 0.7rem; }
  </style>
</head>
<body>

<!-- â•â•â•â• FIREBASE SETUP MODAL â•â•â•â• -->
<div id="setup-modal">
  <div class="modal-box">
    <h2>ğŸ”¥ Configurar Firebase</h2>
    <p>Para sincronizar dados entre dispositivos em tempo real, vocÃª precisa de um projeto Firebase gratuito. Cole as configuraÃ§Ãµes abaixo:</p>
    <p style="color: var(--text); font-size:0.82rem;">
      1. Acesse <strong>console.firebase.google.com</strong><br>
      2. Crie um projeto â†’ Firestore â†’ Regras: <code style="display:inline; padding:2px 6px;">allow read, write: if true;</code><br>
      3. ConfiguraÃ§Ãµes do projeto â†’ Web App â†’ Copie o config:
    </p>
    <div class="form-group"><label>API Key</label><input id="cfg-apiKey" placeholder="AIzaSy..." /></div>
    <div class="form-group"><label>Auth Domain</label><input id="cfg-authDomain" placeholder="meu-projeto.firebaseapp.com" /></div>
    <div class="form-group"><label>Project ID</label><input id="cfg-projectId" placeholder="meu-projeto" /></div>
    <div class="form-group"><label>App ID</label><input id="cfg-appId" placeholder="1:123456789:web:abc..." /></div>
    <div class="flex-end" style="margin-top:16px;">
      <button class="btn btn-outline btn-sm" onclick="usarLocalStorage()">Usar offline (localStorage)</button>
      <button class="btn btn-primary" onclick="iniciarFirebase()">Conectar Firebase</button>
    </div>
    <p class="text-muted mt-8" style="text-align:center;">A configuraÃ§Ã£o fica salva no navegador.</p>
  </div>
</div>

<!-- â•â•â•â• APP â•â•â•â• -->
<div id="app" style="display:none;">
  <header>
    <div class="logo">SAINT<span> GERMAIN</span></div>
    <nav>
      <button class="active" onclick="setTab('pedido')">Pedido</button>
      <button onclick="setTab('historico')">HistÃ³rico</button>
      <button onclick="setTab('produtos')">Produtos</button>
      <button onclick="setTab('clientes')">Clientes</button>
    </nav>
  </header>

  <main>

    <!-- â•â• TAB: NOVO PEDIDO â•â• -->
    <section id="tab-pedido" class="section active">
      <div class="sec-header">
        <div class="sec-title">Novo Pedido</div>
        <button class="btn btn-outline btn-sm" onclick="limparPedido()">Limpar</button>
      </div>

      <!-- Cliente -->
      <div class="card">
        <div class="form-group" style="margin-bottom:8px;">
          <label>Cliente</label>
          <select id="pedido-cliente">
            <option value="">â€” Selecionar cliente â€”</option>
          </select>
        </div>
        <button class="btn btn-outline btn-sm" onclick="abrirDrawer('drawer-cliente')">+ Novo cliente</button>
      </div>

      <!-- Produtos -->
      <div class="card">
        <label style="margin-bottom:10px;">Produtos</label>
        <div class="search-wrap mb-8">
          <span class="search-icon">ğŸ”</span>
          <input id="search-prod" type="text" placeholder="Buscar produto..." oninput="renderProdutosPicker()" />
        </div>
        <div id="pedido-produtos-list"></div>
      </div>

      <!-- Resumo -->
      <div class="card" id="resumo-card" style="display:none;">
        <label style="margin-bottom:10px;">Resumo</label>
        <div id="resumo-itens"></div>
        <div class="resumo-total">
          <span class="label">Total</span>
          <span class="value" id="resumo-total-val">R$ 0,00</span>
        </div>
        <div class="form-group mt-8">
          <label>ObservaÃ§Ãµes</label>
          <textarea id="pedido-obs" placeholder="Ex: entrega terÃ§a, pagamento 30/60/90..."></textarea>
        </div>
        <div class="form-group">
          <label>CondiÃ§Ã£o de Pagamento</label>
          <select id="pedido-pagamento">
            <option value="Ã€ vista">Ã€ vista</option>
            <option value="30 dias">30 dias</option>
            <option value="30/60">30/60</option>
            <option value="30/60/90">30/60/90</option>
            <option value="Boleto">Boleto</option>
            <option value="CartÃ£o">CartÃ£o</option>
            <option value="PIX">PIX</option>
          </select>
        </div>
        <div class="flex-end">
          <button class="btn btn-outline" onclick="imprimirPedido()">ğŸ–¨ Imprimir</button>
          <button class="btn btn-primary" onclick="finalizarPedido()">âœ“ Finalizar Pedido</button>
        </div>
      </div>
    </section>

    <!-- â•â• TAB: HISTÃ“RICO â•â• -->
    <section id="tab-historico" class="section">
      <div class="sec-header">
        <div class="sec-title">HistÃ³rico</div>
        <button class="btn btn-outline btn-sm" onclick="exportarPedidos()">â¬‡ Exportar</button>
      </div>
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-hist" placeholder="Buscar por cliente ou produto..." oninput="renderHistorico()" />
      </div>
      <div id="lista-historico"></div>
    </section>

    <!-- â•â• TAB: PRODUTOS â•â• -->
    <section id="tab-produtos" class="section">
      <div class="sec-header">
        <div class="sec-title">Produtos</div>
        <button class="btn btn-primary btn-sm" onclick="abrirDrawer('drawer-produto')">+ Produto</button>
      </div>
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-produtos" placeholder="Buscar produto..." oninput="renderListaProdutos()" />
      </div>
      <div id="lista-produtos"></div>
    </section>

    <!-- â•â• TAB: CLIENTES â•â• -->
    <section id="tab-clientes" class="section">
      <div class="sec-header">
        <div class="sec-title">Clientes</div>
        <button class="btn btn-primary btn-sm" onclick="abrirDrawer('drawer-cliente')">+ Cliente</button>
      </div>
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="search-clientes" placeholder="Buscar cliente..." oninput="renderListaClientes()" />
      </div>
      <div id="lista-clientes"></div>
    </section>

  </main>
</div>

<!-- â•â•â•â• DRAWERS â•â•â•â• -->

<!-- Drawer Produto -->
<div class="overlay" id="drawer-produto">
  <div class="drawer">
    <div class="drawer-handle"></div>
    <div class="drawer-title" id="drawer-produto-title">Novo Produto</div>
    <input type="hidden" id="prod-id" />
    <div class="form-group"><label>Nome do Produto *</label><input id="prod-nome" placeholder="Ex: Vinho Tinto Reserva 750ml" /></div>
    <div class="form-row">
      <div class="form-group"><label>CÃ³digo / SKU</label><input id="prod-sku" placeholder="VTR-750" /></div>
      <div class="form-group"><label>Categoria</label><input id="prod-categoria" placeholder="Vinhos" /></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>PreÃ§o (R$) *</label><input id="prod-preco" type="number" step="0.01" placeholder="0,00" /></div>
      <div class="form-group"><label>Unidade</label>
        <select id="prod-unidade">
          <option>UN</option><option>CX</option><option>KG</option><option>LT</option><option>DZ</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label>DescriÃ§Ã£o</label><textarea id="prod-desc" placeholder="Detalhes opcionais..."></textarea></div>
    <div class="flex-end">
      <button class="btn btn-outline" onclick="fecharDrawer('drawer-produto')">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarProduto()">Salvar Produto</button>
    </div>
  </div>
</div>

<!-- Drawer Cliente -->
<div class="overlay" id="drawer-cliente">
  <div class="drawer">
    <div class="drawer-handle"></div>
    <div class="drawer-title" id="drawer-cliente-title">Novo Cliente</div>
    <input type="hidden" id="cli-id" />
    <div class="form-group"><label>Nome / RazÃ£o Social *</label><input id="cli-nome" placeholder="Distribuidora ABC Ltda" /></div>
    <div class="form-row">
      <div class="form-group"><label>CNPJ / CPF</label><input id="cli-doc" placeholder="00.000.000/0001-00" /></div>
      <div class="form-group"><label>Telefone</label><input id="cli-tel" placeholder="(48) 99999-9999" type="tel" /></div>
    </div>
    <div class="form-group"><label>E-mail</label><input id="cli-email" type="email" placeholder="contato@empresa.com" /></div>
    <div class="form-group"><label>EndereÃ§o</label><input id="cli-end" placeholder="Rua, nÂº, cidade - UF" /></div>
    <div class="form-group"><label>ObservaÃ§Ãµes</label><textarea id="cli-obs" placeholder="Notas sobre o cliente..."></textarea></div>
    <div class="flex-end">
      <button class="btn btn-outline" onclick="fecharDrawer('drawer-cliente')">Cancelar</button>
      <button class="btn btn-primary" onclick="salvarCliente()">Salvar Cliente</button>
    </div>
  </div>
</div>

<!-- Drawer Pedido Detalhes -->
<div class="overlay" id="drawer-pedido-det">
  <div class="drawer">
    <div class="drawer-handle"></div>
    <div id="pedido-det-content"></div>
    <div class="flex-end">
      <button class="btn btn-outline" onclick="fecharDrawer('drawer-pedido-det')">Fechar</button>
      <button class="btn btn-outline" onclick="imprimirPedidoExistente()">ğŸ–¨ Imprimir</button>
      <button class="btn btn-danger btn-sm" onclick="excluirPedidoAtual()">Excluir</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- Print Area (hidden) -->
<div id="print-area" style="display:none;"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE LAYER (Firebase or localStorage fallback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let db = null;
let useFirebase = false;
let pedidoAtualId = null;

const LOCAL = {
  get: k => JSON.parse(localStorage.getItem(k) || '[]'),
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
};

function usarLocalStorage() {
  useFirebase = false;
  localStorage.removeItem('fb_config');
  document.getElementById('setup-modal').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  init();
  toast('Modo offline ativo');
}

function iniciarFirebase() {
  const cfg = {
    apiKey:    document.getElementById('cfg-apiKey').value.trim(),
    authDomain:document.getElementById('cfg-authDomain').value.trim(),
    projectId: document.getElementById('cfg-projectId').value.trim(),
    appId:     document.getElementById('cfg-appId').value.trim(),
  };
  if (!cfg.apiKey || !cfg.projectId) { toast('Preencha ao menos a API Key e o Project ID'); return; }
  localStorage.setItem('fb_config', JSON.stringify(cfg));
  conectarFirebase(cfg);
}

function conectarFirebase(cfg) {
  try {
    if (!firebase.apps.length) firebase.initializeApp(cfg);
    db = firebase.firestore();
    useFirebase = true;
    document.getElementById('setup-modal').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    init();
    toast('Firebase conectado!');
  } catch(e) {
    toast('Erro ao conectar Firebase: ' + e.message);
  }
}

// â”€â”€ DB OPERATIONS â”€â”€
async function dbGetAll(col) {
  if (useFirebase) {
    const snap = await db.collection(col).get();
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }
  return LOCAL.get(col);
}

async function dbAdd(col, data) {
  if (useFirebase) {
    const ref = await db.collection(col).add({ ...data, _ts: Date.now() });
    return ref.id;
  }
  const arr = LOCAL.get(col);
  const id = 'local_' + Date.now();
  arr.unshift({ id, ...data });
  LOCAL.set(col, arr);
  return id;
}

async function dbUpdate(col, id, data) {
  if (useFirebase) {
    await db.collection(col).doc(id).update(data);
  } else {
    const arr = LOCAL.get(col);
    const i = arr.findIndex(x => x.id === id);
    if (i >= 0) { arr[i] = { ...arr[i], ...data }; LOCAL.set(col, arr); }
  }
}

async function dbDelete(col, id) {
  if (useFirebase) {
    await db.collection(col).doc(id).delete();
  } else {
    const arr = LOCAL.get(col).filter(x => x.id !== id);
    LOCAL.set(col, arr);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let produtos = [];
let clientes = [];
let pedidos  = [];
let cart     = {}; // { prodId: qty }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  await carregarDados();
  renderProdutosPicker();
  renderResumo();
  renderListaProdutos();
  renderListaClientes();
  renderHistorico();
  popularSelectClientes();
}

async function carregarDados() {
  [produtos, clientes, pedidos] = await Promise.all([
    dbGetAll('produtos'),
    dbGetAll('clientes'),
    dbGetAll('pedidos'),
  ]);
  // sort pedidos by timestamp desc
  pedidos.sort((a,b) => (b._ts||0) - (a._ts||0));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTab(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  event.currentTarget.classList.add('active');
  if (name === 'historico') renderHistorico();
  if (name === 'produtos')  renderListaProdutos();
  if (name === 'clientes')  renderListaClientes();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRODUTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProdutosPicker() {
  const q = (document.getElementById('search-prod')?.value||'').toLowerCase();
  const filtered = produtos.filter(p =>
    p.nome.toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q) || (p.categoria||'').toLowerCase().includes(q)
  );
  const el = document.getElementById('pedido-produtos-list');
  if (!filtered.length) {
    el.innerHTML = '<div class="empty" style="padding:20px;"><p>Nenhum produto encontrado</p></div>';
    return;
  }
  el.innerHTML = filtered.map(p => {
    const qty = cart[p.id] || 0;
    return `<div class="prod-pick-item">
      <span class="pname">${p.nome}${p.unidade ? ' <span style="color:var(--muted);font-size:.7rem;">/ '+p.unidade+'</span>' : ''}</span>
      <span class="pprice">${fmtPreco(p.preco)}</span>
      <div class="qty-ctrl">
        <button onclick="addCart('${p.id}',-1)">âˆ’</button>
        <span class="qty-num">${qty}</span>
        <button onclick="addCart('${p.id}',1)">+</button>
      </div>
    </div>`;
  }).join('');
}

function addCart(id, delta) {
  cart[id] = Math.max(0, (cart[id]||0) + delta);
  if (cart[id] === 0) delete cart[id];
  renderProdutosPicker();
  renderResumo();
}

function renderResumo() {
  const itens = Object.entries(cart);
  const card = document.getElementById('resumo-card');
  if (!itens.length) { card.style.display='none'; return; }
  card.style.display='block';
  let total = 0;
  const rows = itens.map(([id, qty]) => {
    const p = produtos.find(x => x.id === id);
    if (!p) return '';
    const sub = p.preco * qty;
    total += sub;
    return `<div class="resumo-item">
      <span>${p.nome} Ã— ${qty}</span>
      <span class="mono" style="color:var(--amber)">${fmtPreco(sub)}</span>
    </div>`;
  }).join('');
  document.getElementById('resumo-itens').innerHTML = rows;
  document.getElementById('resumo-total-val').textContent = fmtPreco(total);
}

function limparPedido() {
  cart = {};
  document.getElementById('pedido-cliente').value = '';
  document.getElementById('pedido-obs').value = '';
  renderProdutosPicker();
  renderResumo();
}

async function finalizarPedido() {
  const clienteId = document.getElementById('pedido-cliente').value;
  if (!clienteId) { toast('Selecione um cliente'); return; }
  const itens = Object.entries(cart);
  if (!itens.length) { toast('Adicione ao menos um produto'); return; }
  const cliente = clientes.find(c => c.id === clienteId);
  const itensPedido = itens.map(([id, qty]) => {
    const p = produtos.find(x => x.id === id);
    return { prodId: id, nome: p.nome, preco: p.preco, qty, subtotal: p.preco * qty };
  });
  const total = itensPedido.reduce((s, i) => s + i.subtotal, 0);
  const pedido = {
    clienteId, clienteNome: cliente.nome,
    itens: itensPedido, total,
    obs: document.getElementById('pedido-obs').value,
    pagamento: document.getElementById('pedido-pagamento').value,
    data: new Date().toISOString(),
    _ts: Date.now(),
    status: 'finalizado',
  };
  await dbAdd('pedidos', pedido);
  pedidos = await dbGetAll('pedidos');
  pedidos.sort((a,b) => (b._ts||0) - (a._ts||0));
  toast('Pedido finalizado!');
  limparPedido();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LISTA PRODUTOS (aba)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderListaProdutos() {
  const q = (document.getElementById('search-produtos')?.value||'').toLowerCase();
  const filtered = produtos.filter(p =>
    p.nome.toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q)
  );
  const el = document.getElementById('lista-produtos');
  if (!filtered.length) {
    el.innerHTML = `<div class="empty"><div class="icon">ğŸ“¦</div><p>Nenhum produto cadastrado.<br/>Clique em "+ Produto" para comeÃ§ar.</p></div>`;
    return;
  }
  el.innerHTML = filtered.map(p => `
    <div class="list-item">
      <div class="info">
        <div class="name">${p.nome}</div>
        <div class="sub">${p.sku ? p.sku + ' Â· ' : ''}${p.categoria||'Sem categoria'}</div>
      </div>
      <span class="badge badge-amber mono">${fmtPreco(p.preco)}</span>
      <div class="actions">
        <button class="btn-icon" onclick="editarProduto('${p.id}');event.stopPropagation()">âœï¸</button>
        <button class="btn-icon" onclick="excluirProduto('${p.id}');event.stopPropagation()">ğŸ—‘</button>
      </div>
    </div>`).join('');
}

function abrirDrawerProduto() {
  document.getElementById('drawer-produto-title').textContent = 'Novo Produto';
  document.getElementById('prod-id').value = '';
  ['prod-nome','prod-sku','prod-categoria','prod-preco','prod-desc'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('prod-unidade').value = 'UN';
  abrirDrawer('drawer-produto');
}

function editarProduto(id) {
  const p = produtos.find(x => x.id === id);
  if (!p) return;
  document.getElementById('drawer-produto-title').textContent = 'Editar Produto';
  document.getElementById('prod-id').value = p.id;
  document.getElementById('prod-nome').value = p.nome || '';
  document.getElementById('prod-sku').value = p.sku || '';
  document.getElementById('prod-categoria').value = p.categoria || '';
  document.getElementById('prod-preco').value = p.preco || '';
  document.getElementById('prod-unidade').value = p.unidade || 'UN';
  document.getElementById('prod-desc').value = p.desc || '';
  abrirDrawer('drawer-produto');
}

async function salvarProduto() {
  const nome = document.getElementById('prod-nome').value.trim();
  const preco = parseFloat(document.getElementById('prod-preco').value);
  if (!nome) { toast('Informe o nome do produto'); return; }
  if (isNaN(preco) || preco < 0) { toast('Informe um preÃ§o vÃ¡lido'); return; }
  const data = {
    nome,
    sku:       document.getElementById('prod-sku').value.trim(),
    categoria: document.getElementById('prod-categoria').value.trim(),
    preco,
    unidade:   document.getElementById('prod-unidade').value,
    desc:      document.getElementById('prod-desc').value.trim(),
  };
  const id = document.getElementById('prod-id').value;
  if (id) {
    await dbUpdate('produtos', id, data);
    toast('Produto atualizado');
  } else {
    await dbAdd('produtos', data);
    toast('Produto salvo');
  }
  produtos = await dbGetAll('produtos');
  fecharDrawer('drawer-produto');
  renderListaProdutos();
  renderProdutosPicker();
}

async function excluirProduto(id) {
  if (!confirm('Excluir este produto?')) return;
  await dbDelete('produtos', id);
  produtos = produtos.filter(x => x.id !== id);
  renderListaProdutos();
  renderProdutosPicker();
  toast('Produto removido');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLIENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function popularSelectClientes() {
  const sel = document.getElementById('pedido-cliente');
  const cur = sel.value;
  sel.innerHTML = '<option value="">â€” Selecionar cliente â€”</option>' +
    clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
  if (cur) sel.value = cur;
}

function renderListaClientes() {
  const q = (document.getElementById('search-clientes')?.value||'').toLowerCase();
  const filtered = clientes.filter(c =>
    c.nome.toLowerCase().includes(q) || (c.doc||'').includes(q) || (c.email||'').toLowerCase().includes(q)
  );
  const el = document.getElementById('lista-clientes');
  if (!filtered.length) {
    el.innerHTML = `<div class="empty"><div class="icon">ğŸ‘¥</div><p>Nenhum cliente cadastrado.<br/>Clique em "+ Cliente" para comeÃ§ar.</p></div>`;
    return;
  }
  el.innerHTML = filtered.map(c => `
    <div class="list-item">
      <div class="info">
        <div class="name">${c.nome}</div>
        <div class="sub">${c.doc||''}${c.doc&&c.tel?' Â· ':''}${c.tel||''}</div>
      </div>
      <div class="actions">
        <button class="btn-icon" onclick="editarCliente('${c.id}');event.stopPropagation()">âœï¸</button>
        <button class="btn-icon" onclick="excluirCliente('${c.id}');event.stopPropagation()">ğŸ—‘</button>
      </div>
    </div>`).join('');
}

function editarCliente(id) {
  const c = clientes.find(x => x.id === id);
  if (!c) return;
  document.getElementById('drawer-cliente-title').textContent = 'Editar Cliente';
  document.getElementById('cli-id').value = c.id;
  document.getElementById('cli-nome').value = c.nome||'';
  document.getElementById('cli-doc').value = c.doc||'';
  document.getElementById('cli-tel').value = c.tel||'';
  document.getElementById('cli-email').value = c.email||'';
  document.getElementById('cli-end').value = c.end||'';
  document.getElementById('cli-obs').value = c.obs||'';
  abrirDrawer('drawer-cliente');
}

async function salvarCliente() {
  const nome = document.getElementById('cli-nome').value.trim();
  if (!nome) { toast('Informe o nome do cliente'); return; }
  const data = {
    nome,
    doc:   document.getElementById('cli-doc').value.trim(),
    tel:   document.getElementById('cli-tel').value.trim(),
    email: document.getElementById('cli-email').value.trim(),
    end:   document.getElementById('cli-end').value.trim(),
    obs:   document.getElementById('cli-obs').value.trim(),
  };
  const id = document.getElementById('cli-id').value;
  if (id) {
    await dbUpdate('clientes', id, data);
    toast('Cliente atualizado');
  } else {
    await dbAdd('clientes', data);
    toast('Cliente salvo');
  }
  clientes = await dbGetAll('clientes');
  fecharDrawer('drawer-cliente');
  renderListaClientes();
  popularSelectClientes();
}

async function excluirCliente(id) {
  if (!confirm('Excluir este cliente?')) return;
  await dbDelete('clientes', id);
  clientes = clientes.filter(x => x.id !== id);
  renderListaClientes();
  popularSelectClientes();
  toast('Cliente removido');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTÃ“RICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistorico() {
  const q = (document.getElementById('search-hist')?.value||'').toLowerCase();
  const filtered = pedidos.filter(p =>
    (p.clienteNome||'').toLowerCase().includes(q) ||
    (p.itens||[]).some(i => i.nome.toLowerCase().includes(q))
  );
  const el = document.getElementById('lista-historico');
  if (!filtered.length) {
    el.innerHTML = `<div class="empty"><div class="icon">ğŸ“‹</div><p>Nenhum pedido registrado ainda.</p></div>`;
    return;
  }
  el.innerHTML = filtered.map(p => {
    const preview = (p.itens||[]).map(i => `${i.nome} Ã—${i.qty}`).join(', ');
    const dt = p.data ? new Date(p.data).toLocaleDateString('pt-BR', {day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : '';
    return `<div class="order-card" onclick="abrirPedidoDet('${p.id}')">
      <div class="order-header">
        <div>
          <div class="order-client">${p.clienteNome||'â€”'}</div>
          <div class="order-id">${dt}</div>
        </div>
        <span class="badge badge-success">${p.pagamento||'â€”'}</span>
      </div>
      <div class="order-items-preview">${preview}</div>
      <div class="order-footer">
        <span class="text-muted">${(p.itens||[]).length} item(s)</span>
        <span class="order-total">${fmtPreco(p.total||0)}</span>
      </div>
    </div>`;
  }).join('');
}

let pedidoDetAtual = null;
function abrirPedidoDet(id) {
  const p = pedidos.find(x => x.id === id);
  if (!p) return;
  pedidoDetAtual = p;
  const dt = p.data ? new Date(p.data).toLocaleDateString('pt-BR', {day:'2-digit',month:'long',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
  const rows = (p.itens||[]).map(i => `
    <div class="resumo-item">
      <span>${i.nome} Ã— ${i.qty}</span>
      <span class="mono" style="color:var(--amber)">${fmtPreco(i.subtotal)}</span>
    </div>`).join('');
  document.getElementById('pedido-det-content').innerHTML = `
    <div class="drawer-title">Pedido â€” ${p.clienteNome}</div>
    <p class="text-muted mb-8">${dt}</p>
    <div class="card" style="margin-bottom:12px;">
      <label style="margin-bottom:8px;">Itens</label>
      ${rows}
      <div class="resumo-total">
        <span class="label">Total</span>
        <span class="value">${fmtPreco(p.total||0)}</span>
      </div>
    </div>
    <div class="card">
      <div class="form-row">
        <div><label>Pagamento</label><p>${p.pagamento||'â€”'}</p></div>
        <div><label>Status</label><span class="badge badge-success">${p.status||'finalizado'}</span></div>
      </div>
      ${p.obs ? `<hr class="divider"/><label>Obs.</label><p style="font-size:.85rem;margin-top:4px;">${p.obs}</p>` : ''}
    </div>`;
  abrirDrawer('drawer-pedido-det');
}

async function excluirPedidoAtual() {
  if (!pedidoDetAtual) return;
  if (!confirm('Excluir este pedido?')) return;
  await dbDelete('pedidos', pedidoDetAtual.id);
  pedidos = pedidos.filter(x => x.id !== pedidoDetAtual.id);
  fecharDrawer('drawer-pedido-det');
  renderHistorico();
  toast('Pedido excluÃ­do');
}

function imprimirPedidoExistente() {
  if (!pedidoDetAtual) return;
  gerarImpressao(pedidoDetAtual);
}

function imprimirPedido() {
  const clienteId = document.getElementById('pedido-cliente').value;
  const cliente = clientes.find(c => c.id === clienteId);
  const itens = Object.entries(cart).map(([id, qty]) => {
    const p = produtos.find(x => x.id === id);
    return { nome: p.nome, qty, preco: p.preco, subtotal: p.preco * qty };
  });
  const total = itens.reduce((s,i)=>s+i.subtotal,0);
  gerarImpressao({
    clienteNome: cliente?.nome || 'â€”',
    itens, total,
    obs: document.getElementById('pedido-obs').value,
    pagamento: document.getElementById('pedido-pagamento').value,
    data: new Date().toISOString(),
  });
}

function gerarImpressao(p) {
  const dt = new Date(p.data).toLocaleDateString('pt-BR',{day:'2-digit',month:'long',year:'numeric'});
  const rows = (p.itens||[]).map(i =>
    `<tr><td>${i.nome}</td><td style="text-align:center">${i.qty}</td><td style="text-align:right">${fmtPreco(i.preco)}</td><td style="text-align:right"><strong>${fmtPreco(i.subtotal)}</strong></td></tr>`
  ).join('');
  const w = window.open('', '_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"/>
  <style>
    body{font-family:sans-serif;padding:32px;color:#000;}
    h1{font-size:1.4rem;margin-bottom:4px;}
    .sub{color:#666;font-size:.8rem;margin-bottom:24px;}
    table{width:100%;border-collapse:collapse;margin-bottom:24px;}
    th{border-bottom:2px solid #000;text-align:left;padding:6px 0;font-size:.8rem;}
    td{border-bottom:1px solid #ddd;padding:6px 0;font-size:.85rem;}
    .total{text-align:right;font-size:1.1rem;font-weight:700;}
    .footer{margin-top:32px;font-size:.78rem;color:#888;}
  </style></head><body>
  <h1>SAINT GERMAIN â€” Pedido de Venda</h1>
  <div class="sub">Emitido em ${dt}</div>
  <p><strong>Cliente:</strong> ${p.clienteNome}</p>
  <p><strong>Pagamento:</strong> ${p.pagamento||'â€”'}</p>
  ${p.obs ? `<p><strong>Obs.:</strong> ${p.obs}</p>` : ''}
  <br/>
  <table>
    <thead><tr><th>Produto</th><th style="text-align:center">Qtd</th><th style="text-align:right">PreÃ§o Un.</th><th style="text-align:right">Subtotal</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>
  <div class="total">TOTAL: ${fmtPreco(p.total||0)}</div>
  <div class="footer">Saint Germain Â· Sistema de Vendas B2B</div>
  </body></html>`);
  w.document.close();
  w.print();
}

function exportarPedidos() {
  const linhas = [['Data','Cliente','Produtos','Total','Pagamento','Obs']];
  pedidos.forEach(p => {
    linhas.push([
      p.data ? new Date(p.data).toLocaleDateString('pt-BR') : '',
      p.clienteNome||'',
      (p.itens||[]).map(i => `${i.nome} x${i.qty}`).join('; '),
      (p.total||0).toFixed(2),
      p.pagamento||'',
      p.obs||''
    ]);
  });
  const csv = linhas.map(r => r.map(c => '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,\uFEFF' + encodeURIComponent(csv);
  a.download = 'pedidos_saint_germain.csv';
  a.click();
  toast('CSV exportado!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function abrirDrawer(id) {
  document.getElementById(id).classList.add('open');
}
function fecharDrawer(id) {
  document.getElementById(id).classList.remove('open');
}
// close on overlay click
document.querySelectorAll('.overlay').forEach(ov => {
  ov.addEventListener('click', e => { if (e.target === ov) fecharDrawer(ov.id); });
});

// reset new-client drawer before opening
const origAbrirDrawer = window.abrirDrawer;
window.abrirDrawer = function(id) {
  if (id === 'drawer-cliente' && !document.getElementById('cli-id').value) {
    document.getElementById('drawer-cliente-title').textContent = 'Novo Cliente';
    ['cli-id','cli-nome','cli-doc','cli-tel','cli-email','cli-end','cli-obs'].forEach(f => document.getElementById(f).value = '');
  }
  document.getElementById(id).classList.add('open');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtPreco(v) {
  return 'R$ ' + Number(v||0).toLocaleString('pt-BR', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const saved = localStorage.getItem('fb_config');
if (saved) {
  try {
    const cfg = JSON.parse(saved);
    document.getElementById('cfg-apiKey').value = cfg.apiKey||'';
    document.getElementById('cfg-authDomain').value = cfg.authDomain||'';
    document.getElementById('cfg-projectId').value = cfg.projectId||'';
    document.getElementById('cfg-appId').value = cfg.appId||'';
    conectarFirebase(cfg);
  } catch(e) { /* show modal */ }
} else {
  // Pre-fill with project config
  document.getElementById('cfg-apiKey').value = 'AIzaSyDyQWt_D950AoJFRCQBFyspG34ti0bWXro';
  document.getElementById('cfg-authDomain').value = 'banco-b2b-sg.firebaseapp.com';
  document.getElementById('cfg-projectId').value = 'banco-b2b-sg';
  document.getElementById('cfg-appId').value = '1:979394861028:web:650b17010d3ed44db219f1';
}
</script>
</body>
</html>
